function runCommand(e,a){if(connection.alive&&connection.socket)connection.socket.emit("command",{name:e,data:a});else{if("chatEvent"==e)game.logs.data=game.logs.data||{},game.logs.data.events=game.logs.data.events||[],game.logs.data.events.push(a),game.logs.update();else if("diceCheck"==e){var t=Object.keys(game.events.data).length;game.events.data["ev"+t]=sync.obj(),game.events.data["ev"+t].data=a,game.events.update();var i={text:a.msg,evID:"ev"+t,ui:a.ui,user:sync.eval("@me.pName",sync.defaultContext()),href:a.icon};game.logs.data=game.logs.data||{},game.logs.data.events=game.logs.data.events||[],game.logs.data.events.push(i),game.logs.update()}else"media"==e&&($("#dragMedia").length||media_init(),mediaPlayer.command(a));console.log(e+" : "+a+" <NO CONNECTION>")}}function connection_init(){function e(){isNaN(ntp.offset())||(_offset=ntp.offset()),setTimeout(function(){e()},1e4)}var a=localStorage.getItem(getCookie("offlineGame")),t=io();ntp.init(t),connection.alive||setTimeout(function(){e()},1e3),t.emit("auth",{userID:getCookie("UserID")}),t.on("p2p",function(e){comms.message(e)}),t.on("disconnect",function(e){console.log("disconnected"),$.ajax({url:"/",error:function(e){if(console.log(e),game.config&&game.config.data.offline){layout.page({title:"You have entered offline mode",prompt:"Editing is limited, but you can still access all your data. Rejoin the server and you will be able to upload your changes.",blur:.8})}else{layout.page({title:"Oops, looks like your connection was broken!",prompt:"The server appears to be down, or your internet connection is. Either way please refresh the page to resume editing.",blur:.8})}},dataType:"json",success:function(e){sendAlert({text:"Reconnect initilaized"}),console.log("Reconnect Attempt"),connection_init()},type:"GET"})}),t.on("shutdown",function(e){function a(e,t){if(e)return _shutDownTime-dateCorrected()>0?(e.text(String(Math.floor((_shutDownTime-dateCorrected(-500))/1e3)).formatTime()),setTimeout(function(){a(e)},50),!0):_shutDownTime-dateCorrected()>-1500?(e.text("0".formatTime()),setTimeout(function(){a(e)},1e3),!0):(e.parent().remove(),!0)}var t=$("<div>");t.addClass("flexcolumn focus outline flexmiddle spadding smooth fit-xy");var i=$("<b>").appendTo(t);i.attr("title",e.msg),i.css("font-size","3.0em"),t.append("<p>"+e.msg+"</p>"),_shutDownTime=e.endTime,a(i),sendAlert({text:e.msg||"Server will shut down soon, please wrap up your changes.",duration:18e4}),notify(t,{title:"Server Shutdown"})}),t.on("command",function(e){var a=e.header;if(a){var t=a.id,i=duplicate(e.data);if("alert"==a.type)sendAlert("vg");else if("updateCollection"==a.type)game.locals.stamps&&(game.locals.stamps.data.sets=i,game.locals.stamps.update());else if("view"==a.type){for(var s in game.state._apps)$("#"+game.state._apps[s]).length&&($("#"+game.state._apps[s]).attr("tab",i.index),$("#"+game.state._apps[s]).attr("resourcePath",i.path),$("#"+game.state._apps[s]).attr("forced",!0));game.state.update(),game.config.update(),layout.coverlay($(".piece-quick-edit"))}else if("updateBoardLayer"==a.type)a.userID!=getCookie("UserID")&&boardApi.applyUpdate(a.userID,i);else if("event"==a.type){if(!game.events.data[t]){var o=sync.obj(t);game.events.data[t]=o}if(a.ui&&util.contains(i.players,getCookie("UserID"))&&a.popout){var n=sync.newApp(a.ui);n.attr("event","true"),game.events.data[t].addApp(n);layout.page({title:i.title,prompt:i.prompt,blur:.5}).append(n)}game.events.data[t].update(i),game.events.update()}else if("cursor"==a.type){if(game.entities.data[i.id]&&null!=i){var l=getEnt(i.id),r=l.data;r.cursors=r.cursors||{},i.data.b?(r.beacons=r.beacons||[],r.beacons.push({x:i.data.x,y:i.data.y,col:game.players.data[t].color,owner:t,size:0})):r.cursors[t]=i.data,t!=getCookie("UserID")&&!hasSecurity(t,"Assistant Master")&&hasSecurity(getCookie("UserID"),"Assistant Master")&&$(".tab").each(function(){if($(this).is(":visible")){var e=game.state.data.tabs[$(this).attr("tabKey")];if(e&&e.index==i.id&&(layout.coverlay("player-marker-"+t),game.players.data[t])){for(var a=14,s=0;s<Object.keys(game.players.data).length;s++)if(Object.keys(game.players.data)[s]==t&&t!=getCookie("UserID")){a+=10*s;break}var o=$("<div>").appendTo($(this));o.addClass("outline"),o.attr("id","player-marker-"+t),o.attr("index",e.index),o.attr("uID",t),o.attr("title",game.players.data[t].displayName),o.css("position","absolute"),o.css("left",a),o.css("bottom","0"),o.css("width","8px"),o.css("height","8px"),o.css("background-color",game.players.data[t].color||"white"),o.css("border-top-left-radius","8px"),o.css("border-top-right-radius","8px")}}})}}else if("move"==a.type){if(game.entities.data[t]&&null!=i&&a.userID!=getCookie("UserID")&&i.data){var d=getEnt(t),r=d.data,c=i.data,p=r.layers[i.layer][i.type][i.index],u=.1*util.dist(p.x,c.x,p.y,c.y)/Math.max(c.w,c.h);"w"==i.type?(r.layers[i.layer][i.type][i.index]=c,$(".application[ui-name='ui_board']").each(function(){if(boardApi.apps[$(this).attr("id")]&&boardApi.apps[$(this).attr("id")].board==t){var e=boardApi.apps[$(this).attr("id")].stage,a=e.children[1].children[i.layer];if(a&&a.children&&a.children.length){var s=a.children[4];s.children&&s.children[i.index]&&s.children[i.index].update()}boardApi.rebuildFog(d,$(this))}})):p.i!=c.i||p.eID!=c.eID?(r.layers[i.layer][i.type][i.index]=c,boardApi.updateObject(i.layer,i.type,i.index,d),$(".piece-quick-edit-app").length&&$(".piece-quick-edit-app").attr("idstr")==t+"-"+i.layer+"-p-"+i.index&&sync.updateApp($(".piece-quick-edit-app"),d)):($(".application[ui-name='ui_board']").each(function(){var e=$(this).attr("UserID")||getCookie("UserID");if(boardApi.apps[$(this).attr("id")]&&boardApi.apps[$(this).attr("id")].board==t){var a=boardApi.apps[$(this).attr("id")].stage,s=a.children[1].children[i.layer];if(s&&s.children&&s.children.length)if("p"==i.type){var o=s.children[2];if(o.children&&o.children[i.index]&&(o.children[i.index].animate(c,p,u),boardApi.fog[t]&&boardApi.fog[t].length&&c.eID)){var n=getEnt(c.eID);if(n&&n.data&&"c"==n.data._t&&hasSecurity(e,"Visible",n.data)){var r=null;if(c.eID&&c.o&&c.o.Sight){var n=getEnt(c.eID),g=sync.defaultContext();n&&n.data&&(g[n.data._t]=duplicate(n.data));var m=c.o.Sight;r=boardApi.scale(sync.eval(m.d,g),d,!0)}boardApi.apps[$(this).attr("id")].views[i.layer+"-"+i.type+"-"+i.index]=boardApi.buildDynamicFog(d,$(this),c.x+c.w/2,c.y+c.h/2,r),boardApi.rebuildDynamicFog(d,$(this))}else boardApi.apps[$(this).attr("id")].views&&boardApi.apps[$(this).attr("id")].views[i.layer+"-p-"+y]&&(boardApi.apps[$(this).attr("id")].views[i.layer+"-p-"+y].destroy(!0),delete boardApi.apps[$(this).attr("id")].views[i.layer+"-p-"+y],boardApi.rebuildDynamicFog(l,$(this)))}}else if("d"==i.type){var f=s.children[3];f.children&&f.children[i.index]&&f.children[i.index].animate(c,p,u)}else if("t"==i.type){var h=s.children[1];h.children&&h.children[i.index]&&h.children[i.index].animate(c,p,u)}}}),r.layers[i.layer][i.type][i.index]=c)}}else if("handout"==a.type){var g=game.entities.data[t];if(g&&g.data){i.sender&&sendAlert({text:"Handout from "+getPlayerName(i.sender)});var m=$("<div>");if(m.addClass("flexcolumn flex"),"b"==g.data._t){var f=sync.newApp("ui_board").appendTo(m);f.attr("viewOnly","true"),g.addApp(f)}else{var f=sync.newApp(i.ui||"ui_renderPage").appendTo(m);f.attr("viewOnly","true"),g.addApp(f)}m.attr("viewOnly",!hasSecurity(getCookie("UserID"),"Rights",g.data));var h=ui_popOut({title:i.name,target:$("body"),minimize:!0,maximize:!0,dragThickness:"0.5em",resizable:!0,style:{width:assetTypes[g.data._t].width,height:assetTypes[g.data._t].height}},m);h.css("padding","0px"),h.addClass("floating-app"),h.resizable()}}else if("entity"==a.type){if(!game.entities.data[t]&&null!=i){var o=sync.obj(t);game.entities.data[t]=o}null==i?delete game.entities.data[t]:hook.call("AssetUpdate",t,i)&&(a.merge?game.entities.data[t].update(i,Object.keys(i)):game.entities.data[t].update(i)),game.entities.update()}else if("storage"==a.type){if(!game.locals.storage){var o=sync.obj("storage");game.locals.storage=o}var v;a.add?(game.locals.storage.data.l.push(i),v=game.locals.storage.data):v=i.data;var x=[];for(var y in v.l){var b=v.l[y];if(!isNaN(b._uid)||v.s[b._uid])if(b._uid&&v.s[b._uid]){v.s[b._uid]instanceof Object||(v.s[b._uid]={data:v.s[b._uid]});var w=v.s[b._uid].data;if(!(w instanceof Object))try{var T=JSON.parse(w);T._uid=b._uid,v.s[b._uid]=sync.obj(getCookie("UserID")+"_"+b._uid),v.s[b._uid].data=T}catch(e){v.s[b._uid]=sync.obj(getCookie("UserID")+"_"+b._uid),v.s[b._uid].data=duplicate(game.templates.page)}}else x.push(y);else!function(e){$.ajax({url:"/retrieveAsset?id="+e._uid,error:function(e){console.log(e)},dataType:"json",success:function(a){var t=game.locals.storage.data;t.s[e._uid]instanceof Object||(t.s[e._uid]=a);var i=t.s[e._uid].data;if(!(i instanceof Object))try{var s=JSON.parse(i);s._uid=e._uid,t.s[e._uid]=sync.obj(getCookie("UserID")+"_"+e._uid),t.s[e._uid].data=s}catch(a){t.s[e._uid]=sync.obj(getCookie("UserID")+"_"+e._uid),t.s[e._uid].data=duplicate(game.templates.page)}game.locals.storage.update(t)},type:"GET"})}(b)}for(var s=x.length-1;s>=0;s--)i.data.l.splice(x[s],1);game.locals.storage.update(v)}else if("players"==a.type){if(!game.players){var o=sync.obj("players");game.players=o}for(var C in game.players.data)$(".cursor-"+C).length&&!i[C]&&$(".cursor-"+C).remove();game.players.update(i)}else if("config"==a.type)game.config.update(i),game.config.data.tracks&&audioChannels.prepTracks(game.config.data.tracks);else if("music"==a.type)i.cmd?audioChannels[i.cmd](i.index,i.ind,i.val):i.src!=globalSnd.src||globalSnd.paused?(globalSnd.src=i.src,globalSnd.volume=i.volume||.2,globalSnd.play()):globalSnd.stop();else if("command"==a.type)util.commands&&util.commands[i.cmd]&&util.commands[i.cmd](i,a.userID);else if("effect"==a.type)util.playEffect(i);else if("template"==a.type)for(var C in i)game.templates[C]=i[C];else if("tags"==a.type)game.templates.tags=i;else if("state"==a.type)if(game.state.update(i),game.state.data.combat){if(a.combat&&hasSecurity(getCookie("UserID"),"Assistant Master")&&$("#main-menu").length&&0==$("#main-menu").css("opacity")&&$("#main-menu").attr("docked")&&($("#combat-button").click(),util.dockReveal($("#main-menu"))),!hasSecurity(getCookie("UserID"),"Assistant Master")&&getPlayerCharacter(getCookie("UserID"))){var g=getPlayerCharacter(getCookie("UserID"));if(g&&g.data){if(Object.keys(game.state.data.combat.engaged[g.id()]).length)layout.coverlay("olay-join-combat"),layout.coverlay("join-combat");else if(game.state.data.combat&&0==$("#olay-join-combat").length){var k=Math.max(util.getMaxZ(".main-dock"),util.getMaxZ(".ui-popout")),_=layout.overlay({target:$("body"),id:"olay-join-combat",style:{"background-color":"rgba(0,0,0,0.7)"}});_.css("z-index",k+1),_.fadeIn(),_.addClass("flexcolumn flexmiddle"),_.click(function(){layout.coverlay(_),layout.coverlay("join-combat")});var I=$("<div>").appendTo(_);if(I.css("position","absolute"),I.css("width","100%"),I.css("top","10%"),I.addClass("flexmiddle bounce"),I.hide(),I.fadeIn(),sync.rawVal(g.data.info.img)){var D=$("<div>").appendTo(_);D.css("width","30vw"),D.css("height","60vh"),layout.mobile&&(D.css("width","200px"),D.css("height","300px")),D.css("background-image","url('"+sync.rawVal(g.data.info.img)+"')"),D.css("background-size","cover"),D.css("background-repeat","no-repeat"),D.css("background-position","center 0"),D.css("box-shadow","0 0 8px 8px #111 inset"),D.css("border-radius","2px")}var A=["IT'S FIGHTING TIME","Things are about to get ugly","What's that? Combat you say?","CHAARRRRGEEE!","Still More FIGHTING",'"... And I\'m all out of gum"',"Raise those fists!"],j=$("<highlight>").appendTo(I);j.text(A[Math.floor(Math.random()*A.length)]),j.addClass("combat"),layout.mobile&&(I.css("top",""),I.css("bottom","20%"),j.css("font-size","1.6em")),_actions["Set/Roll Initiative"].click(null,_,g,_,{pump:!0}),$("#join-combat").css("z-index",k+2)}}else layout.coverlay("olay-join-combat"),layout.coverlay("join-combat")}}else layout.coverlay("olay-join-combat"),layout.coverlay("join-combat");else if("logs"==a.type&&game.logs)game.logs.update(i);else if("comms"==a.type){if("localMute"==i.cmd)comms.localMute(i.from);else if("localUnMute"==i.cmd)comms.localUnMute(i.from);else if("reveal"==i.cmd)if(hasSecurity(i.from,"Assistant Master")&&i.players&&i.players.length)for(var s=0;s<i.players.length;s++)comms.reveal(i.players[s]);else comms.reveal(i.from);else if("hide"==i.cmd)if(hasSecurity(i.from,"Assistant Master")&&i.players&&i.players.length)for(var s=0;s<i.players.length;s++)comms.hide(i.players[s]);else comms.hide(i.from);if("disconnect"==i.cmd)$("#web-cam-"+i.from).fadeOut();else if(hasSecurity(i.from,"Assistant Master"))if("mute"==i.cmd)for(var s=0;s<i.players.length;s++)comms.mute(i.players[s]);else if("unmute"==i.cmd)for(var s=0;s<i.players.length;s++)comms.unmute(i.players[s]);else if("deafen"==i.cmd)for(var s=0;s<i.players.length;s++)comms.deafen(i.players[s]);else if("undeafen"==i.cmd)for(var s=0;s<i.players.length;s++)comms.undeafen(i.players[s]);else if("channel"==i.cmd)for(var s=0;s<i.players.length;s++)comms.channel(i.players[s],i.channels)}else if("media"==a.type)$("#dragMedia").length||media_init(),mediaPlayer.command(i);else if("reaction"==a.type){if("true"==getCookie("disableReactions")||$("#chat-button").hasClass("outline"))return!1;if(_nextSound<Date.now()&&!_winHasFocus){var S=new Audio("/sounds/snap.wav");S.volume=.1,S.play(),_nextSound=Date.now()+1e4}var P=i,O=!1;util.matchYoutube(i)&&(O=util.matchYoutube(i),i="/content/youtube.ico");var E=ui_processMedia(i,{id:"reaction-media-"+a.id});E.css("transition","height 1s"),E.css("pointer-events","none"),E.css("min-width",.1*Math.max($(window).width(),$(window).height())+"px"),E.css("min-height",.1*Math.max($(window).width(),$(window).height())+"px");var G=$("#player-icon-"+a.id),U="top";$("#web-cam-"+a.id).length&&(G=$("#web-cam-"+a.id),U=null);var j="";layout.mobile&&(G=$($(".main-dock")[3]),j=game.players.data[t].displayName+"'s reaction");var N;if(E.is("img"))E.css("width",Math.max($("#player-image-plate-"+t).outerWidth(),150)),layout.mobile&&E.css("width",Math.max(G.width()/2,150)),E.on("load",function(){var e=ui_popOut({target:G,align:U,id:"reaction-frame-"+a.id,userID:a.id,noCss:!0,hideclose:!0,title:j,style:{"background-color":"white",cursor:"pointer","max-height":"50vh","max-width":"35vw"}},E),t=util.getMaxZ(".ui-popout");e.css("z-index",t+1),e.contextmenu(function(){return layout.coverlay("reaction-frame-"+a.id,500),!1}),e.click(function(){if(O)return void(hasSecurity(getCookie("UserID"),"Assistant Master")&&(runCommand("media",{cmd:"update",data:O}),$(this).remove()));var e=$("#reaction-media-"+$(this).attr("UserID")),a=layout.overlay({target:$("body"),style:{"background-color":"rgba(0,0,0,0.8)",cursor:"pointer","pointer-events":"auto"}}),t=util.getMaxZ(".ui-popout");a.css("z-index",t+1),a.addClass("flexmiddle");var i=e.outerWidth()/e.outerHeight(),s=$("<div>").appendTo(a);s.css("background-color","white");var o=$("<img>").appendTo(s);i>1?(o.css("height","auto"),o.css("width",.6*$(window).outerWidth())):(o.css("height",.6*$(window).outerHeight()),o.css("width","auto")),o.attr("src",e.attr("src")),o.css("pointer-events","none"),a.click(function(){N=!0,layout.coverlay($(this),500)})}),P.match(".gif")?setTimeout(function(){(!$("#reaction-frame-"+a.id+":hover").length||layout.mobile&&!N)&&layout.coverlay(e,500)},12e3):setTimeout(function(){(!$("#reaction-frame-"+a.id+":hover").length||layout.mobile&&!N)&&layout.coverlay(e,500)},4e3),getCookie("UserID")!=a.id&&hasSecurity(a.id,"Assistant Master")&&(N=!0,e.click())});else{E.attr("width",Math.max($("#player-image-plate-"+t).outerWidth(),150)),layout.mobile&&E.css("width",Math.max(G.width()/2,150)),E.bind("ended",function(){$("#reaction-frame-"+t+":hover").length&&!layout.mobile?E[0].play():layout.coverlay("reaction-frame-"+t,500)});var z=ui_popOut({target:G,align:U,id:"reaction-frame-"+a.id,userID:a.id,title:j,noCss:!0,hideclose:!0,style:{"background-color":"white",cursor:"pointer"}},E),M=util.getMaxZ(".ui-popout");z.css("z-index",M+1),z.contextmenu(function(){return layout.coverlay("reaction-frame-"+a.id,500),!1}),z.click(function(){var e=$("#reaction-media-"+$(this).attr("UserID")),a=layout.overlay({target:$("body"),style:{"background-color":"rgba(0,0,0,0.8)",cursor:"pointer","pointer-events":"auto"}}),t=util.getMaxZ(".ui-popout");a.css("z-index",t+1),a.addClass("flexmiddle");var i=e.outerWidth()/e.outerHeight();e[0].pause();var s=$("<video>").appendTo(a);i>1?(s.attr("height","auto"),s.attr("width",.6*$(window).outerWidth())):(s.attr("height",.6*$(window).outerHeight()),s.attr("width","auto")),s.attr("muted",!0),s.attr("autoplay",!0),s.attr("loop",!0),s.attr("src",e.attr("src")),s.css("pointer-events","none"),s[0].currentTime=e[0].currentTime,s[0].play(),a.click(function(){layout.coverlay($(this),500),e[0].currentTime=s[0].currentTime,e[0].play()})}),getCookie("UserID")!=a.id&&hasSecurity(a.id,"Assistant Master")&&z.click()}}}}),t.on("goOffline",function(e){try{game.owner==getCookie("UserID")&&(game.config.data.offline=e.offline,setCookie("offlineGame",e.gameID,999999999999999),localStorage.setItem(getCookie("offlineGame"),JSON.stringify(game))),connection.alive=!1,t.disconnect(),sendAlert({text:"You are now offline"});for(var i in _syncList)_syncList[i].update()}catch(e){sendAlert({text:"Game is too large to be taken offline"}),runCommand("goOnline",JSON.stringify(JSON.parse(a||"{}").entities)),setCookie("offlineGame","")}}),t.on("breakConnection",function(e){game.locals.gameBackup=duplicate(game),connection.alive=!1,t.disconnect()}),t.on("initialize",function(e){layout.mobile&&$("#viewPort").empty(),setupGame(),game.templates=e.templates;var a={};for(var i in game.templates.constants)a[String(i).toLowerCase()]=game.templates.constants[i];game.config.data=e.config,game.state.data=e.state,game.owner=e.owner,game.locals.gameList=e.games,game.id=e.gameID,_authToken=e.authToken,game.user=e.userData,game.state.data.setting=game.state.data.setting||{};for(var s in e.events){var o=e.events[s];if(!game.events.data[s]){var n=sync.obj(s);game.events.data[s]=n}game.events.data[s].update(o),game.events.update()}for(var s in e.entities){var o=e.entities[s];if(!game.entities.data[s]&&null!=o){var n=sync.obj(s);game.entities.data[s]=n}null==o?delete game.entities.data[s]:game.entities.data[s].update(o),game.entities.update()}if(game.logs.data=e.logs,t.emit("p2p",getCookie("UserID")),connection.alive||(layout.init(),loadNotify()),!isNaN(game.templates.version)&&game.locals.gameList[game.templates.identifier]&&game.locals.gameList[game.templates.identifier].version&&game.templates.version<game.locals.gameList[game.templates.identifier].version&&hasSecurity(getCookie("UserID"),"Game Master")){var l=layout.overlay({target:$("body"),style:{"background-color":"rgba(0,0,0,0.5)"}});l.addClass("flexcolumn flexmiddle"),l.append("<h1 class='alttext'>Your game is outdated, please update to the latest version</h1>"),connection.alive=!0;var r=$("<button>").appendTo(l);r.addClass("focus"),r.append("UPDATE GAME TEMPLATES"),r.click(function(){l.empty(),setTimeout(function(){var e=$("<button>").appendTo(l);e.append("Refresh"),e.click(function(){window.location.reload()})},1e3),game.locals.gameList[game.templates.identifier]?runCommand("updateTemplate",game.templates.identifier):sendAlert({text:"This is a custom game, can't restore templates(still being built)"})});var r=$("<button>").appendTo(l);r.append("Proceed anyway"),r.click(function(){l.remove()})}if(connection.alive=!0,hasSecurity(getCookie("UserID"),"Assistant Master")||game.config.data.players&&game.config.data.players[getCookie("UserID")]&&(null!=game.config.data.players[getCookie("UserID")].entity||getEnt(game.config.data.players[getCookie("UserID")].entity))){if(game.config.data.players&&game.config.data.players[getCookie("UserID")]&&null!=game.config.data.players[getCookie("UserID")].entity&&getEnt(game.config.data.players[getCookie("UserID")].entity)){runCommand("selectPlayerColor",{col:game.config.data.players[getCookie("UserID")].color,userID:getCookie("UserID")});var d=getEnt(game.config.data.players[getCookie("UserID")].entity);assetTypes[d.data._t].preview(d,$("body"));runCommand("selectPlayerEntity",{id:d.id()}),sendAlert({text:"Impersonating Character"}),$(".chatType").text("IC"),$(".chatType").addClass("highlight alttext"),$(".chatType").attr("title","In Character"),$(".application[ui-name='_imperson']").attr("src",sync.rawVal(d.data.info.img)||"/content/icons/blankchar.png"),$(".application[ui-name='_imperson']").attr("ICText",sync.rawVal(d.data.info.name)),$(".application[ui-name='_imperson']").each(function(){sync.updateApp($(this),game.players)})}}else{var c=layout.page({title:"Choose your Character",prompt:"Select or create a character you will be playing with",blur:.5,id:"character-select",width:"auto"}),p=$("<div>").appendTo(c);p.addClass("flexrow");var u=sync.render("ui_colorPicker")(sync.dummyObj(),c,{hideColor:!0,vertical:!0,colors:["rgba(34,34,34,1)","rgba(187,0,0,1)","rgba(255,153,0,1)","rgba(255,240,0,1)","rgba(0,187,0,1)","rgba(0,115,230,1)","rgba(176,0,187,1)","rgba(255,115,255,1)","rgba(255,255,255,1)"],colorChange:function(e,a,t){runCommand("selectPlayerColor",{col:t,userID:getCookie("UserID")}),sendAlert({text:"Color Selected"}),u.css("background",t)}}).appendTo(p),g=$("<div>").appendTo(p);g.addClass("flexrow lightoutline smooth flexwrap flexaround");var m=sync.render("ui_assetPicker")(game.entities,g,{rights:"Rights",filter:"c",sessionOnly:!0,select:function(e,a,t,i,s){assetTypes[t.data._t].preview(t,$("body"));runCommand("selectPlayerEntity",{id:t.id()}),sendAlert({text:"Impersonating Character"}),$(".chatType").text("IC"),$(".chatType").addClass("highlight alttext"),$(".chatType").attr("title","In Character"),$(".application[ui-name='_imperson']").attr("src",sync.rawVal(t.data.info.img)||"/content/icons/blankchar.png"),$(".application[ui-name='_imperson']").attr("ICText",sync.rawVal(t.data.info.name)),$(".application[ui-name='_imperson']").each(function(){sync.updateApp($(this),game.players)}),layout.coverlay("character-select",500)}}).appendTo(g);m.css("width",assetTypes.assetPicker.width),m.css("height",assetTypes.assetPicker.width),m.addClass("white")}hook.call("Initialize",e)}),connection.socket=t}function openSplash(e,a){var t=layout.overlay({target:$("body"),id:"splash-screen"});t.addClass("flexrow flexaround"),t.css("background","rgba(0,0,0,0.8)"),t.css("font-size","");var i=util.getMaxZ(".ui-popout");if(t.css("z-index",i+1),!getCookie("UserID").valid()){$("#auth").click(function(){ui_popOut({target:$(this),align:"bottom",id:"auth-dialog",style:{width:"10vw"}},authDialog())})}var s=$("<div>").appendTo(t);s.addClass("flexcolumn flex lpadding");var o=$("<div>").appendTo(t);o.addClass("flexcolumn flex2 flexmiddle");var s=$("<div>").appendTo(t);s.addClass("flexcolumn flex lpadding");var n=$("<div>").appendTo(o);n.addClass("flexcolumn flexmiddle"),n.css("background","radial-gradient(rgba(255,255,255,0.4), rgba(255,255,255,0.3), rgba(255,255,255,0.05), rgba(255,255,255,0), rgba(255,255,255,0))");var l=$("<div>").appendTo(n);l.css("width","35vh"),l.css("height","35vh"),l.css("background-image","url('/content/brand.png')"),l.css("background-repeat","no-repeat"),l.css("background-size","cover"),l.css("background-position","center");var r=$("<text>").appendTo(o);r.addClass("flexcolumn flexmiddle hover2 lrpadding"),r.css("color","white"),r.css("font-size","2em"),r.css("font-family","Arial"),r.css("text-shadow","0px 0px 1px rgb(235,235,228)"),r.css("margin-bottom","1em"),r.text("Use in fullscreen!"),r[0].addEventListener("click",function(){var e=document.documentElement;(e.requestFullscreen||e.webkitRequestFullScreen||e.mozRequestFullScreen||e.msRequestFullscreen).call(e)});var d=$("<div>").appendTo(o);if(d.addClass("flexcolumn"),d.css("min-width","262px"),!window.mobilecheck()&&e){var c=$("<button>").appendTo(d);c.addClass("hardoutline smooth highlight flex flexmiddle hover2 padding"),c.css("margin-bottom","1em");var r=$("<text>").appendTo(c);r.addClass("flexmiddle"),r.css("color","white"),r.css("font-size","2em"),r.css("font-family","Arial"),r.css("text-shadow","0px 0px 3px black"),r.text("Resume"),c.click(function(){layout.coverlay($("#splash-screen"),500)})}if("true"==$("#viewPort").attr("host")||1==$("#viewPort").attr("host")){var p=$("<div>").appendTo(d);p.addClass("flexcolumn hardoutline smooth background flex flexmiddle hover2 padding");var r=$("<text>").appendTo(p);r.addClass("flexmiddle bold"),r.attr("id","join"),r.css("color","white"),r.css("font-size","2em"),r.css("font-family","Arial"),r.css("text-shadow","0px 0px 3px black"),r.text("Join a Game!");var u=!1;p.click(function(){$(this);if($("#join").fadeOut(500),$(this).css("min-height",$(this).height()),u)return!0;u=!0,setTimeout(function(){var e=genInput({parent:p,classes:"fit-x line alttext margin middle subtitle",placeholder:"Place Game Invite here"}),a=$("<div>").appendTo(p);a.addClass("fit-x"),a.text("Join through Invite"),a.css("font-size","1.4em"),a.css("font-family","Arial"),a.click(function(){e.match("http")?window.location.href=e.val():window.location.href="http://"+e.val()})},400)});var g=$("<div>").appendTo(d);g.addClass("hardoutline smooth background flex flexmiddle hover2 padding");var r=$("<text>").appendTo(g);r.addClass("flexmiddle bold"),r.attr("id","start"),r.css("color","white"),r.css("font-size","2em"),r.css("font-family","Arial"),r.css("text-shadow","0px 0px 3px black"),r.text("Start a Game!");var m=!1;g.click(function(){if($("#start").fadeOut(),$(this).css("min-height",$(this).height()),m)return!0;m=!0,setTimeout(function(){var e=$("<div>").appendTo(g),a=(sync.render("ui_filePicker")(sync.obj(),e,{filter:"world",hideURL:!0,change:function(e,a,t){$.ajax({url:"/loadGame",error:function(e){console.log(e)},dataType:"text/plain",data:{gameData:t,gameName:t},success:function(e){window.location.href="/join",layout.coverlay($("#splash-screen"),500)},type:"GET"})}}).addClass("white smooth").css("color","#333").css("width","400px").css("height","200px").appendTo(e),$("<button>").appendTo(e));a.addClass("highlight alttext"),a.css("font-size","1.2em"),a.append("Start a New Game"),a.click(function(){var e=($(this).attr("index"),layout.page({title:"Creating Game...",prompt:"",width:"800px",blur:.5,id:"gamePreview",style:{"z-index":"100000000000000"}})),t=$("<div>").appendTo(e);t.addClass("flexcolumn"),game.locals.createSession=sync.obj("createSession"),game.locals.createSession.data={name:sync.newValue("Enter Your Game Title","An adventure begins..."),password:sync.newValue("Enter Your Password"),capacity:sync.newValue("Max Players",1,1,10),img:sync.newValue("Image Goes Here")};var i=$("<div>").appendTo(t);i.addClass("flexcolumn"),genIcon("refresh","Refresh").appendTo(i).click(function(){$.ajax({url:"/workshopSync",error:function(e){console.log(e)},dataType:"JSON",success:function(e){a.click(),sendAlert({text:"succcess"})},type:"GET"})});var s=$("<div>").appendTo(i);s.append($("<b>Sample Games</b>").addClass("flexmiddle"));var o=genIcon("wrench","Browse Workshop").appendTo(i);o.attr("target","_"),o.attr("href","https://steamcommunity.com/app/842250/workshop/");var n=$("<div>").appendTo(s);n.addClass("flexrow flexwrap smooth");for(var l in game.locals.gameList)if(!1!==game.locals.gameList[l].show){var r=$("<div>").appendTo(n);r.addClass("hover2 outline smooth"),game.locals.createSession.data.game==l&&r.addClass("highlight"),r.css("background-image","url('"+sync.rawVal(game.locals.gameList[l].info.img)+"')"),r.css("background-repeat","no-repeat"),r.css("background-position","center"),r.css("background-size","cover"),r.css("width","9em"),r.css("height","6em"),game.locals.gameList[l].beta&&(r.css("position","relative"),r.append("<highlight style='-webkit-text-stroke-color:white; position : absolute; top:0; left:0; font-size:0.8em; font-family:Arial;' class='highlight outline smooth lrpadding'>Beta</highlight>")),r.attr("index",l),r.attr("img",sync.rawVal(game.locals.gameList[l].info.img)),r.click(function(){game.locals.createSession.data.game=$(this).attr("index"),game.locals.createSession.data.img=$(this).attr("img"),game.locals.createSession.data.templates=game.locals.gameList[$(this).attr("index")],game.locals.createSession.update();var e=sync.obj();e.data=duplicate(game.locals.gameList[$(this).attr("index")].character),game.templates=game.templates||game.locals.gameList[$(this).attr("index")],u.empty(),p.width(375);var a=sync.render("ui_characterSheet")(e,r,{sheet:game.locals.gameList[$(this).attr("index")].display.sheet,viewOnly:!0,local:!0}).appendTo(u);a.css("width","750px"),a.css("height","800px"),a.css("zoom","50%"),n.children().each(function(){$(this).removeClass("highlight")}),$(this).addClass("highlight"),m.show()});var d=$("<p>").appendTo(r);d.addClass("fit-xy alttext flexmiddle subtitle"),d.css("background","linear-gradient(to top, rgba(0,0,0,0), rgba(0,0,0,0.4), rgba(0,0,0,0))"),d.text(sync.rawVal(game.locals.gameList[l].info.name)),d.hide(),r.hover(function(){$(this).children().fadeIn()},function(){$(this).children().fadeOut()})}var c=$("<div>").appendTo(t);c.addClass("flexcolumn flex");var p=$("<div>"),u=$("<div>").appendTo(c);u.addClass("flexcolumn fit-x flexmiddle"),p.css("height","400px");var g=$("<div>").appendTo(c);g.addClass("flexcolumn flexaround flex");var m=$("<button>").appendTo(g);m.addClass("flexmiddle highlight alttext"),m.css("font-size","2em"),m.append("Create"),m.hide(),m.click(function(){var e=game.locals.createSession.data;e.templates;ui_prompt({target:$(this),inputs:{"File Name":{placeholder:"No Special Characters"}},style:{"z-index":"10000000000000000000000000"},click:function(a,t){t["File Name"].val()&&$.ajax({url:"/loadGame",error:function(e){console.log(e)},dataType:"json",data:{gameName:"/custom/"+t["File Name"].val()+".world",gameKey:e.game},success:function(e){window.location.href="/join",layout.coverlay($("#splash-screen"),500)},type:"GET"})}})})})},800)});var r=$("<a>").appendTo(d);r.addClass("flexmiddle bold dull spadding"),r.attr("id","start"),r.css("font-family","Arial"),r.css("text-shadow","0px 0px 3px black"),r.text("Exit"),r.click(function(){$.ajax({url:"/exit",error:function(e){console.log(e)},dataType:"json",success:function(e){},type:"GET"})});var f=$("<div>").appendTo(o);f.addClass("flexcolumn flexmiddle"),f.css("height","8vh"),f.append("<text style='color : white;' class='subtitle'>Game Master, LLC © 2017</text>"),f.append("<a class='subtitle' style='color : white;' href='http://wiki.gmforge.io/index.php/Terms_of_Service' target='_'>Terms of Service</a>"),"true"==$("#redeemCode").attr("about")&&($("#about").click(),$("#redeemCode").removeAttr("about"))}else{for(var h=1;h<8;h++){var g=$("<div>").appendTo(d);g.addClass("button smooth white hover2 flex flexmiddle padding"),g.attr("index",h);var r=$("<text>").appendTo(g);r.addClass("flexmiddle bold"),r.css("font-family","Arial"),r.css("text-shadow","0px 0px 3px black"),r.text("Join as Player "+h),g.click(function(){window.location.href="/join?userID=player_"+$(this).attr("index")})}var r=$("<a>").appendTo(d);r.addClass("flexmiddle bold dull spadding"),r.attr("id","start"),r.css("font-family","Arial"),r.css("text-shadow","0px 0px 3px black"),r.text("Exit"),r.click(function(){$.ajax({url:"/exit",error:function(e){console.log(e)},dataType:"json",success:function(e){},type:"GET"})})}}function openSplash(e,a){var t=layout.overlay({target:$("body"),id:"splash-screen"});t.addClass("flexrow flexaround"),t.css("background","rgba(0,0,0,0.8)"),t.css("font-size","");var i=util.getMaxZ(".ui-popout");if(t.css("z-index",i+1),!getCookie("UserID").valid()){$("#auth").click(function(){ui_popOut({target:$(this),align:"bottom",id:"auth-dialog",style:{width:"10vw"}},authDialog())})}var s=$("<div>").appendTo(t);s.addClass("flexcolumn flex lpadding");var o=$("<div>").appendTo(t);o.addClass("flexcolumn flex2 flexmiddle")
;var s=$("<div>").appendTo(t);s.addClass("flexcolumn flex lpadding");var n=$("<div>").appendTo(o);n.addClass("flexcolumn flexmiddle"),n.css("background","radial-gradient(rgba(255,255,255,0.4), rgba(255,255,255,0.3), rgba(255,255,255,0.05), rgba(255,255,255,0), rgba(255,255,255,0))");var l=$("<div>").appendTo(n);l.css("width","35vh"),l.css("height","35vh"),l.css("background-image","url('/content/brand.png')"),l.css("background-repeat","no-repeat"),l.css("background-size","cover"),l.css("background-position","center");var r=$("<div>").appendTo(o);if(r.addClass("flexcolumn"),r.css("min-width","262px"),!window.mobilecheck()&&e){var d=$("<button>").appendTo(r);d.addClass("hardoutline smooth highlight flex flexmiddle hover2 padding"),d.css("margin-bottom","1em");var c=$("<text>").appendTo(d);if(c.addClass("flexmiddle"),c.css("color","white"),c.css("font-size","2em"),c.css("font-family","Arial"),c.css("text-shadow","0px 0px 3px black"),c.text("Resume"),d.click(function(){layout.coverlay($("#splash-screen"),500)}),"true"==$("#viewPort").attr("local")||1==$("#viewPort").attr("local")){var d=$("<button>").appendTo(r);d.addClass("hardoutline smooth background flex flexmiddle hover2 padding"),d.css("margin-bottom","1em");var c=$("<text>").appendTo(d);c.addClass("flexmiddle"),c.css("color","white"),c.css("font-size","2em"),c.css("font-family","Arial"),c.css("text-shadow","0px 0px 3px black"),c.text("Rejoin as GM"),d.click(function(){window.location.href="/join?userID=localhost"})}}if("true"==$("#viewPort").attr("host")||1==$("#viewPort").attr("host")){var p=$("<div>").appendTo(r);p.addClass("flexcolumn hardoutline smooth background flex flexmiddle hover2 padding");var c=$("<text>").appendTo(p);c.addClass("flexmiddle bold"),c.attr("id","join"),c.css("color","white"),c.css("font-size","2em"),c.css("font-family","Arial"),c.css("text-shadow","0px 0px 3px black"),c.text("Join a Game!");var u=!1;p.click(function(){$(this);if($("#join").fadeOut(500),$(this).css("min-height",$(this).height()),u)return!0;u=!0,setTimeout(function(){var e=genInput({parent:p,classes:"fit-x line alttext margin middle subtitle",placeholder:"Place Game Invite here"}),a=$("<div>").appendTo(p);a.addClass("fit-x"),a.text("Join through Invite"),a.css("font-size","1.4em"),a.css("font-family","Arial"),a.click(function(){e.val().match("http")?window.location.href=e.val():window.location.href="http://"+e.val()})},400)});var g=$("<div>").appendTo(r);g.addClass("hardoutline smooth background flex flexmiddle hover2 padding");var c=$("<text>").appendTo(g);c.addClass("flexmiddle bold"),c.attr("id","start"),c.css("color","white"),c.css("font-size","2em"),c.css("font-family","Arial"),c.css("text-shadow","0px 0px 3px black"),c.text("Start a Game!");var m=!1;g.click(function(){if($("#start").fadeOut(),$(this).css("min-height",$(this).height()),m)return!0;m=!0,setTimeout(function(){function e(){$.ajax({url:"/getWorlds",error:function(e){console.log(e)},dataType:"json",success:function(e){o=e,s.empty(),0==e.length&&f.addClass("highlight bounce");for(var a in e){var t=$("<div>").appendTo(s);t.addClass("link"),t.attr("val",e[a]),t.text(e[a]),t.click(function(){var e=$(this).attr("val");$.ajax({url:"/loadGame",error:function(e){console.log(e)},dataType:"json",data:{gameData:e,gameName:e},success:function(e){window.location.href="/join",layout.coverlay($("#splash-screen"),500)},type:"GET"})})}},type:"GET"})}var a=$("<div>").appendTo(g),t=$("<div>").appendTo(a);t.addClass("flexmiddle subtitle");var i=genIcon("folder-open","Open In File Browser").appendTo(t);i.addClass("alttext lrpadding"),i.attr("filename","/"),i.css("color","white"),i.click(function(e){$.ajax({url:"/openFiles?path=/worlds",type:"GET"})});var s=$("<div>").appendTo(a);s.addClass("white smooth scroll-y"),s.css("color","#333"),s.css("width","400px"),s.css("height","200px");var o;e();var n=$("<button>").appendTo(a);n.addClass("background alttext"),n.css("font-size","1.2em"),n.append("Refresh Worlds"),n.click(function(){$.ajax({url:"/workshopSync",error:function(a){console.log(a),e()},dataType:"json",success:function(a){e()},type:"GET"})});var n=$("<button>").appendTo(a);n.addClass("highlight alttext"),n.css("font-size","1.2em"),n.append("Start a New Game"),n.click(function(){$.ajax({url:"/workshopSync",error:function(e){console.log(e)},dataType:"json",success:function(e){$.ajax({url:"/gameList",error:function(e){console.log(e)},dataType:"json",success:function(e){game.locals.gameList=e.list;var a=($(this).attr("index"),layout.page({title:"Creating Game...",prompt:"",width:"800px",blur:.5,id:"gamePreview",style:{"z-index":"100000000000000"}})),t=$("<div>").appendTo(a);t.addClass("flexcolumn"),game.locals.createSession=sync.obj("createSession"),game.locals.createSession.data={name:sync.newValue("Enter Your Game Title","An adventure begins..."),password:sync.newValue("Enter Your Password"),capacity:sync.newValue("Max Players",1,1,10),img:sync.newValue("Image Goes Here")};var i=$("<div>").appendTo(t);i.addClass("flexcolumn");var s=$("<div>").appendTo(i),l=$("<div>").appendTo(s);l.addClass("flexmiddle");var r=$("<div>").appendTo(l);r.addClass("flexmiddle"),r.hide();var d=$("<button>").appendTo(r);d.addClass("highlight alttext hover2"),d.text("V2 Systems (HTML)"),d.click(function(){$(this).parent().children().removeClass("highlight").addClass("background"),$(this).addClass("highlight").removeClass("background"),p.children().each(function(){$(this).attr("build")?$(this).show():$(this).hide()})});var d=$("<button>").appendTo(r);d.addClass("background alttext hover2"),d.text("V1 Systems (JSON)"),d.click(function(){$(this).parent().children().removeClass("highlight").addClass("background"),$(this).addClass("highlight").removeClass("background"),p.children().each(function(){$(this).attr("build")?$(this).hide():$(this).show()})}),l.append("<div class='lrpadding lrmargin'></div>"),genIcon("refresh","Refresh").appendTo(l).click(function(){$.ajax({url:"/workshopSync",error:function(e){console.log(e)},dataType:"json",success:function(e){$.ajax({url:"/gameList",error:function(e){console.log(e),n.click()},dataType:"json",success:function(e){game.locals.gameList=e.list,n.click(),sendAlert({text:"success"})},type:"GET"})},type:"GET"})}),l.append("<div class='lrpadding lrmargin'></div>");var c=genIcon("wrench","Browse the Workshop!").appendTo(l);c.attr("target","_"),c.attr("href","https://steamcommunity.com/app/842250/workshop/");var p=$("<div>").appendTo(s);p.addClass("flexrow flexwrap smooth");for(var u in game.locals.gameList)if(!1!==game.locals.gameList[u].show){var g=$("<div>").appendTo(p);g.addClass("hover2 outline smooth"),g.attr("build",game.locals.gameList[u].build),game.locals.gameList[u].build||(g.hide(),r.show()),game.locals.createSession.data.game==u&&g.addClass("highlight"),g.css("background-image","url('"+sync.rawVal(game.locals.gameList[u].info.img)+"')"),g.css("background-repeat","no-repeat"),g.css("background-position","center"),g.css("background-size","cover"),g.css("width","9em"),g.css("height","6em"),game.locals.gameList[u].beta&&(g.css("position","relative"),g.append("<highlight style='-webkit-text-stroke-color:white; position : absolute; top:0; left:0; font-size:0.8em; font-family:Arial;' class='highlight outline smooth lrpadding'>Beta</highlight>")),g.attr("index",u),g.attr("img",sync.rawVal(game.locals.gameList[u].info.img)),g.click(function(){game.locals.createSession.data.game=$(this).attr("index"),game.locals.createSession.data.img=$(this).attr("img"),game.locals.createSession.data.templates=game.locals.gameList[$(this).attr("index")],game.locals.createSession.update(),v.empty();var e=$("<img>").appendTo(v);e.attr("src",game.locals.gameList[$(this).attr("index")].info.img.current),e.css("max-height","200px"),p.children().each(function(){$(this).removeClass("highlight")}),$(this).addClass("highlight"),d.show()});var m=$("<p>").appendTo(g);m.addClass("fit-xy alttext flexmiddle subtitle"),m.css("background","linear-gradient(to top, rgba(0,0,0,0), rgba(0,0,0,0.4), rgba(0,0,0,0))"),m.text(sync.rawVal(game.locals.gameList[u].info.name)),m.hide(),g.hover(function(){$(this).children().fadeIn()},function(){$(this).children().fadeOut()})}var f=$("<div>").appendTo(t);f.addClass("flexcolumn flex");var h=$("<div>"),v=$("<div>").appendTo(f);v.addClass("flexcolumn fit-x flexmiddle"),h.css("height","400px");var x=$("<div>").appendTo(f);x.addClass("flexcolumn flexaround flex");var d=$("<button>").appendTo(x);d.addClass("flexmiddle highlight alttext"),d.css("font-size","2em"),d.append("Create"),d.hide(),d.click(function(){var e=game.locals.createSession.data;e.templates;ui_prompt({target:$(this),inputs:{"File Name":{placeholder:"No Special Characters"}},style:{"z-index":"10000000000000000000000000"},click:function(a,t){t["File Name"].val()&&(util.contains(o,t["File Name"].val()+".world")?alert("A world already exists with that name"):$.ajax({url:"/loadGame",error:function(e){console.log(e)},dataType:"json",data:{gameName:t["File Name"].val()+".world",gameKey:e.game},success:function(e){window.location.href="/join",layout.coverlay($("#splash-screen"),500)},type:"GET"}))}})})},type:"GET"})},type:"GET"})})},800)});var f=$("<a>").appendTo(r);f.addClass("flexmiddle bold dull spadding"),f.attr("target","_"),f.attr("href","https://steamcommunity.com/sharedfiles/filedetails/?id=1398462708"),f.css("font-family","Arial"),f.css("color","white"),f.css("text-shadow","0px 0px 3px black"),f.text("Multiplayer Setup!");var c=$("<a>").appendTo(r);c.addClass("flexmiddle bold dull spadding"),c.attr("id","start"),c.css("font-family","Arial"),c.css("color","white"),c.css("text-shadow","0px 0px 3px black"),c.text("Options/Users"),c.click(function(){$.ajax({url:"/getOptions",error:function(e){console.log(e)},dataType:"json",success:function(e){function a(){n.empty();for(var t in e.accounts){var i=e.accounts[t],s=$("<div>").appendTo(n);s.addClass("flexcolumn"),s.css("margin-bottom","2em");var o=$("<div>").appendTo(s);o.addClass("flexrow flexbetween lrpadding"),o.append(t);var l=genIcon("remove","Delete Account").appendTo(o);l.addClass("destroy subtitle"),l.attr("index",t),l.click(function(){var t=$(this).attr("index");ui_prompt({target:$(this),click:function(){delete e.accounts[t],$.ajax({url:"/updateOptions",error:function(e){console.log(e)},data:{options:JSON.stringify(e,2,2)},dataType:"json",success:function(){a()},type:"GET"})}})});var r=$("<div>").appendTo(s);r.addClass("flexrow flexbetween");var d=genInput({parent:r,value:i.displayName,placeholder:"Display Name",classes:"line lrmargin flex subtitle",index:t});d.change(function(){var t=$(this).attr("index");e.accounts[t].displayName=$(this).val(),$.ajax({url:"/updateOptions",error:function(e){console.log(e)},data:{options:JSON.stringify(e,2,2)},dataType:"json",success:function(){a()},type:"GET"})});var d=genInput({parent:r,value:i.password,placeholder:"Password (Optional)",classes:"line lrmargin flex subtitle",index:t});d.change(function(){var t=$(this).attr("index");e.accounts[t].password=$(this).val(),$.ajax({url:"/updateOptions",error:function(e){console.log(e)},data:{options:JSON.stringify(e,2,2)},dataType:"json",success:function(){a()},type:"GET"})});var c=$("<select>");c.attr("index",t),c.append("<option value=1>Game Master</option>"),c.append("<option value=2>Assistant Master</option>"),c.append("<option value=3>Player</option>"),c.change(function(){var t=$(this).attr("index");e.accounts[t].rank=$(this).val(),$.ajax({url:"/updateOptions",error:function(e){console.log(e)},data:{options:JSON.stringify(e,2,2)},dataType:"json",success:function(){a()},type:"GET"})})}}var t=$("<div>");t.addClass("flexcolumn flex");var i=$("<div>").appendTo(t);i.addClass("flexrow subtitle lrpadding"),i.append("<b>Host Display Name</b>"),genInput({parent:i,value:e.hostName,placeholder:"localhost",classes:"line lrmargin flex subtitle"}).change(function(){e.hostName=$(this).val(),$.ajax({url:"/updateOptions",error:function(e){console.log(e)},data:{options:JSON.stringify(e,2,2)},dataType:"json",success:function(){a()},type:"GET"})});var i=$("<div>").appendTo(t);i.addClass("flexrow subtitle lrpadding"),i.append("<b>Remote GM Password</b>"),genInput({parent:i,value:e.hostPW,placeholder:"Remote GM Password",classes:"line lrmargin flex subtitle"}).change(function(){e.hostPW=$(this).val(),$.ajax({url:"/updateOptions",error:function(e){console.log(e)},data:{options:JSON.stringify(e,2,2)},dataType:"json",success:function(){a()},type:"GET"})});var i=$("<div>").appendTo(t);i.addClass("flexrow subtitle lrpadding");var s=genInput({type:"checkbox",parent:i});s.change(function(){e.fullscreen=1==$(this).prop("checked"),$.ajax({url:"/updateOptions",error:function(e){console.log(e)},data:{options:JSON.stringify(e,2,2)},dataType:"json",success:function(e){},type:"GET"})}),s.prop("checked",e.fullscreen),i.append("<b>Fullscreen on start</b>");var i=$("<div>").appendTo(t);i.addClass("flexrow subtitle lrpadding"),i.append("<b>Port</b>"),genInput({classes:"line lrmargin fit-x",parent:i,type:"number",min:1,max:55555,value:e.port||3e4}).change(function(){e.port=$(this).val(),$.ajax({url:"/updateOptions",error:function(e){console.log(e)},data:{options:JSON.stringify(e,2,2)},dataType:"json",success:function(e){},type:"GET"})});var o=$("<div>").appendTo(t);o.addClass("flex"),o.css("overflow","auto"),o.css("position","relative");var n=$("<div>").appendTo(o);n.addClass("fit-x"),n.css("position","absolute"),a();var l=genIcon("plus","New Account").appendTo(t);l.addClass("create flexmiddle fit-x"),l.click(function(){ui_prompt({target:$(this),inputs:{"Account Name":""},click:function(t,i){e.accounts[i["Account Name"].val()]={},$.ajax({url:"/updateOptions",error:function(e){console.log(e)},data:{options:JSON.stringify(e,2,2)},dataType:"json",success:function(){a()},type:"GET"})}})}),ui_popOut({target:$("body"),id:"port-options",title:"Client Options",style:{width:"400px",height:"400px"}},t)},type:"GET"})});var c=$("<a>").appendTo(r);c.addClass("flexmiddle bold dull spadding"),c.attr("id","start"),c.css("font-family","Arial"),c.css("color","white"),c.css("text-shadow","0px 0px 3px black"),c.text("Exit"),c.click(function(){$.ajax({url:"/exit",error:function(e){console.log(e)},dataType:"json",success:function(e){},type:"GET"})});var h=$("<div>").appendTo(o);h.addClass("flexcolumn flexmiddle"),h.css("height","8vh"),h.append("<text style='color : white;' class='subtitle'>Game Master, LLC © 2017</text>"),"true"==$("#redeemCode").attr("about")&&($("#about").click(),$("#redeemCode").removeAttr("about"))}else{var v=$("<div>").appendTo(r);v.addClass("flexcolumn"),$.ajax({url:"/getOptions",error:function(e){console.log(e);for(var a=1;a<8;a++){var t=$("<div>").appendTo(v);t.addClass("button smooth white hover2 flex flexmiddle padding"),t.attr("index",a);var i=$("<text>").appendTo(t);i.addClass("flexmiddle bold"),i.css("font-family","Arial"),i.css("text-shadow","0px 0px 3px black"),i.text("Join as Player "+a),t.click(function(){window.location.href="/join?userID=player_"+$(this).attr("index")})}},dataType:"json",success:function(e){for(var a in e.accounts){var t=$("<div>").appendTo(v);t.addClass("button smooth white hover2 flex flexmiddle padding"),t.attr("index",a);var i=$("<text>").appendTo(t);i.addClass("flexmiddle bold"),i.css("font-family","Arial"),i.css("text-shadow","0px 0px 3px black"),i.text("Join as "+(e.accounts[a].displayName||a)),t.click(function(){var a=$(this).attr("index");e.accounts[a].password?ui_prompt({target:$(this),inputs:{Password:""},click:function(e,t){window.location.href="/join?userID="+a+"&password="+t.Password.val()}}):window.location.href="/join?userID="+a})}}});var c=$("<a>").appendTo(r);c.addClass("flexmiddle bold alttext spadding"),c.attr("id","start"),c.css("font-family","Arial"),c.css("text-shadow","0px 0px 3px black"),c.css("color","white"),c.text("Main Menu"),c.click(function(){window.location.href="/"});var c=$("<a>").appendTo(r);c.addClass("flexmiddle bold dull spadding"),c.attr("id","start"),c.css("font-family","Arial"),c.css("text-shadow","0px 0px 3px black"),c.css("color","white"),c.text("Exit"),c.click(function(){$.ajax({url:"/exit",error:function(e){console.log(e)},dataType:"json",success:function(e){},type:"GET"})})}}!function(e){var a,t={},i=[];t.init=function(e,t){t=t||{},a=e,a.on("ntp:server_sync",s),setInterval(o,t.interval||1e3)};var s=function(e){var a=Date.now()-e.t1+(Date.now()-e.t0)/2;i.unshift(a),i.length>10&&i.pop()};t.offset=function(){for(var e=0,a=0;a<i.length;a++)e+=i[a];return e/=i.length};var o=function(){a.emit("ntp:client_sync",{t0:Date.now()})};"function"==typeof define&&define.amd?define("ntp",[],function(){return t}):e.ntp=t}(window);var _nextSound=0,_shutDownTime,globalSnd=new Audio,_deleting=!1,_authToken,_lastFilePicker="Local",_localAuth=!1,_authTokenCloud,_lastSamplePick,_audioPreview;sync.render("ui_filePicker",function(e,a,t){t=t||{};var i=$("<div>");i.addClass("fit-xy flexcolumn");var s=genNavBar(null,"flex");s.addClass("fit-x flex"),s.appendTo(i),(!t.filter||"img"==t.filter||t.filter instanceof Object&&util.contains(t.filter,"img"))&&s.generateTab("Sample Content","folder-open",function(e){var t=$("<div>").appendTo(e);t.addClass("flexcolumn flex"),layout.mobile||(t.on("dragover",function(e){if(e.preventDefault(),e.stopPropagation(),!$("#"+a.attr("id")+"-drag-overlay").length){var t=layout.overlay({target:i,id:a.attr("id")+"-drag-overlay",style:{"background-color":"rgba(0,0,0,0.5)","pointer-events":"none","z-index":"1000000000000"}});t.addClass("flexcolumn flexmiddle alttext"),t.css("z-index",util.getMaxZ(".ui-popout")+1),t.css("font-size","2em"),t.append("<b>Drop to Upload</b>")}}),t.on("drop",function(e){e.preventDefault(),e.stopPropagation();var t=e.originalEvent.dataTransfer;if(t.getData("Text")){var i=new Image;i.src=t.getData("Text"),i.onload=function(){n.val($(this).attr("src")),n.change()}}layout.coverlay(a.attr("id")+"-drag-overlay")}),t.on("dragleave",function(e){e.preventDefault(),e.stopPropagation(),layout.coverlay(a.attr("id")+"-drag-overlay")}),t.mouseout(function(){layout.coverlay(a.attr("id")+"-drag-overlay")}));var s=genNavBar(null,"flex","4px");s.addClass("fit-x flex"),s.removeClass("flexcolumn"),s.addClass("flexrow"),$(s.children()[0]).removeClass("flexrow").addClass("flexcolumn subtitle middle"),s.appendTo(t);for(var o in util.art)!function(e){s.generateTab(e,"",function(a){a.css("position","relative"),a.css("overflow","auto"),_lastSamplePick=e;var t=$("<div>").appendTo(a);t.addClass("flexrow flexwrap fit-x"),t.css("position","absolute");for(var i in util.art[e]){var s=$("<img>").appendTo(t);s.addClass("outline hover2"),s.css("cursor","pointer"),"Icons"==e||"Nouns"==e?(s.css("width","48px"),s.css("height","48px")):(s.css("height","128px"),t.addClass("flexaround flex")),util.art[e][i]instanceof Object?s.attr("src",util.art[e][i].src):s.attr("src","/content/icons/"+util.art[e][i]),s.click(function(){n.val($(this).attr("src")),n.change()})}if($("<div>").addClass("flex").appendTo(a),"Nouns"==e){var o=$("<div>").appendTo(a);o.addClass("subtitle bold flexmiddle alttext outline"),o.css("background-color","rgba(0,0,0,0.8)"),o.append("<a href='/content/nouns/credits.txt' target='_' class='lrpadding lrmargin'>Art by : The Noun Project</a>")}if("Sci-fi"==e){var o=$("<div>").appendTo(a);o.addClass("subtitle bold flexmiddle alttext outline"),o.css("background-color","rgba(0,0,0,0.8)"),o.append("<a href='http://thompsonpeters.com/eote/maps/' target='_' class='lrpadding lrmargin'>Art by : Peter Thompson,<br> check out his site!</a>");var s=$("<img>").appendTo(o);s.addClass("round"),s.attr("src","/content/peter/peter.png"),s.css("width","64px"),s.css("height","64px")}if("Area"==e){var o=$("<div>").appendTo(a);o.addClass("subtitle bold flexmiddle alttext outline"),o.css("background-color","rgba(0,0,0,0.8)"),o.append("<a href='https://www.patreon.com/blueswordgames' target='_' class='lrpadding lrmargin'>Art by : Blue Sword Games,<br> check out his patreon!</a>");var s=$("<img>").appendTo(o);s.addClass("round"),s.attr("src","/content/bluesword/bluesword.jpg"),s.css("width","64px"),s.css("height","64px")}if("Dungeons"==e){var o=$("<div>").appendTo(a);o.addClass("subtitle bold flexmiddle alttext outline"),o.css("background-color","rgba(0,0,0,0.8)"),o.append("<a href='https://www.patreon.com/elventower' target='_' class='lrpadding lrmargin'>Art by : Elven Tower Cartography,<br> check out his patreon!</a>");var s=$("<img>").appendTo(o);s.attr("src","/content/etc/etc.png"),s.css("width","64px"),s.css("height","64px")}if("Worldmaps"==e){var o=$("<div>").appendTo(a);o.addClass("subtitle bold flexmiddle alttext outline"),o.css("background-color","rgba(0,0,0,0.8)"),o.append("<a href='https://arsheesh.deviantart.com/art/A-Free-Fantasy-Map-294623008' target='_' class='lrpadding lrmargin'>Art by : Arsheesh,<br> check out his deviantart!</a>");var s=$("<img>").appendTo(o);s.attr("src","https://a.deviantart.net/avatars/a/r/arsheesh.png?5"),s.css("width","64px"),s.css("height","64px")}})}(o);s.selectTab(_lastSamplePick||"Icons"),_lastFilePicker=null}),layout.mobile||s.generateTab("Local","inbox",function(i){sync.render("ui_fileBrowser")(e,a,{filter:t.filter,change:function(e,a,t){n.val(t),n.change()}}).appendTo(i),_lastFilePicker="Local"});var o=$("<div>").appendTo(i);o.addClass("flexrow subtitle"),t.hideURL&&o.hide();var n=genInput({parent:o,placeholder:"Direct URL",value:t.value});n.addClass("flex"),n.change(function(e){if(t.change&&t.change instanceof Function){var a=$(this).val().split("\\"),i=a[a.length-1].split("/")[a[a.length-1].split("/").length-1],s="";for(var o in a)s+=a[o],o<a.length-1&&(s+="/");t.change(e,$(this),s,i)}});var l=$("<div>").appendTo(o);return l.addClass("background hover2 outline alttext flexmiddle spadding"),l.css("font-size","1.2em"),l.text("Clear/Delete"),l.click(function(){n.val(""),n.change()}),s.selectTab(_lastFilePicker||"Sample Content"),i}),sync.render("ui_fileBrowser",function(e,a,t){function i(s){function n(e,a){var s=$("<div>");s.addClass("flexcolumn"),s.css("color","#333");var r=$("<div>");r.addClass("flexcolumn");var d;e.path?d=genIcon("folder-close"):(d=genIcon("folder-close","New Folder"),d.addClass("subtitle")),d.addClass("alttext lrpadding"),d.attr("filename",e.path),d.css("color","white"),d.click(function(e){var a=$(this).attr("filename")||"\\";ui_prompt({target:$(this),id:"hover",inputs:{"Folder Name":{placeholder:"Enter Folder Name"}},click:function(e,t){t["Folder Name"].val()&&(sendAlert({text:"Creating..."}),_deleting=!0,$.ajax({url:"/create",data:{path:a+t["Folder Name"].val(),userID:getCookie("UserID"),auth:l},error:function(e){console.log(e),_deleting=!1,sendAlert({text:"Creation Failed"})},dataType:"json",success:function(e){_deleting=!1,i(e),sendAlert({text:"Created Folder\\custom\\"+a+t["Folder Name"].val()})}}))}}),e.stopPropagation(),e.preventDefault()});var p=$("<div>").appendTo(r);p.addClass("flexcolumn");var g=$("<div>").appendTo(r);if(g.addClass("flexcolumn fileContent"),g.attr("path",e.path),g.sortable({connectWith:".fileContent",update:function(e,a){e.stopPropagation(),e.preventDefault();var a=$(a.item),t=!1;if(g.children().each(function(){$(this).attr("path")==a.attr("path")&&(t=!0)}),t)$(a.item).remove();else{var s=g.attr("path"),o=a.attr("filename").replace(a.attr("path"),""),n=a.attr("filename"),r="";"\\"!=n[0]&&"/"!=n[0]?n="\\"+n:r="\\",$.ajax({url:"/move",data:{userID:getCookie("UserID"),auth:l,path:n,newPath:s+r+o},error:function(e){console.log(e),e.responseText&&sendAlert({text:e.responseText}),$.ajax({url:"/files",error:function(e){console.log(e)},dataType:"json",success:function(e){i(e)},type:"GET"})},dataType:"json",success:function(e){i(e)}})}}}),e.path){var m=e.path;m=m.substring(0,m.length-1),m=m.split("\\"),m=m[m.length-1];var f=$("<div>").appendTo(s);f.addClass("flexrow flexbetween lrpadding alttext bold hover2"),f.attr("filename",e.path),f.css("text-align","left");var h=genIcon("",m).appendTo(f);h.addClass("subtitle");var v=$("<div>").appendTo(f);v.addClass("flexrow");var x=genIcon("cloud-upload").appendTo(v);x.attr("filename",e.path),x.attr("title","Upload file to folder"),x.click(function(e){u.attr("path",$(this).attr("filename")),u.click(),e.stopPropagation(),e.preventDefault()}),d.appendTo(v),d.attr("title","Creates a new folder in this folder");var y=genIcon("trash").appendTo(v);y.attr("filename",e.path),y.click(function(e){var a=$(this).attr("filename");_deleting?sendAlert({text:"Deletion in progress"}):("\\"!=a[0]&&"/"!=a[0]&&(a="\\"+a),ui_prompt({target:$(this),confirm:"Delete Folder",inputs:{Confirmation:{placeholder:"Type 'Delete' to confirm"}},click:function(e,t){"Delete"==t.Confirmation.val()&&(_deleting=!0,sendAlert({text:"Deleting..."}),f.remove(),$.ajax({url:"/delete",data:{userID:getCookie("UserID"),auth:l,path:a},error:function(e){console.log(e),_deleting=!1,sendAlert({text:"Deletion Failed..."})},dataType:"json",success:function(e){_deleting=!1,i(e),sendAlert({text:"Deleted Successfully..."})}}))}})),e.stopPropagation(),e.preventDefault()}),layout.fileControls||(x.hide(),d.hide(),y.hide()),f.click(function(){g.is(":visible")?($(this).removeClass("highlight outlinebottom"),$(this).addClass("background"),r.hide(),delete o.data[$(this).attr("filename")]):(o.data[$(this).attr("filename")]=!0,$(this).removeClass("background"),$(this).addClass("highlight outlinebottom"),r.show())}),p.css("margin-left","1em"),g.css("margin-left","1em"),g.css("margin-bottom","4px"),g.css("min-height","1px"),o.data[e.path]?(f.addClass("highlight outlinebottom"),r.show()):(f.addClass("background"),r.hide())}else if(c.children().length<=1){d.appendTo(c),d.removeClass("subtitle");var x=genIcon("cloud-upload","Upload").appendTo(c);x.addClass("alttext lrpadding"),x.attr("filename","/"),x.css("color","white"),x.click(function(e){u.attr("path",$(this).attr("filename")),u.click(),e.stopPropagation(),e.preventDefault()}),layout.fileControls||(x.hide(),d.hide());var x=genIcon("folder-open","Open In File Browser").appendTo(c);x.addClass("alttext lrpadding"),x.attr("filename","/"),x.css("color","white"),x.click(function(e){$.ajax({url:"/openFiles",type:"GET"})});var b=$("<div>");b.addClass("flexrow fit-x flexmiddle");var w=genIcon("search").appendTo(b);w.addClass("lrpadding alttext"),w.attr("title","Search");var T=genInput({classes:"flex",parent:b,placeholder:"Search Terms"}).addClass("subtitle");T.keyup(function(e){var a=($(this).val()||"").toLowerCase();g.children().each(function(){if($(this).attr("index")&&a){resourceWrap.hide();var e=getEnt($(this).attr("index"));if(e){var t=(sync.rawVal(e.data.info.name)||"").toLowerCase(),i=!1;for(var s in e.data.tags)if(s.match(String(a))){i=!0;break}t.match(String(a))&&(i=!0),i?$(this).show():$(this).hide()}}else resourceWrap.show(),$(this).fadeIn()})})}r.appendTo(s);for(var C in e.c){var k=e.c[C];if(k instanceof Object)n(k,(a||0)+1).appendTo(p);else{var _=k;_=_.split("\\"),_=_[_.length-1];var I=$("<div>").appendTo(g);I.addClass("flexrow lrpadding outlinebottom white"),I.attr("filename",k),I.attr("path",e.path),I.css("text-align","left"),I.css("font-family","Scaly Sans"),C==e.c.length-1&&I.removeClass("outlinebottom"),I.contextmenu(function(e){var a=$(this),t=a.attr("filename").replace(a.attr("path"),""),s=a.attr("filename");ui_prompt({target:$(this),inputs:{Rename:{value:t.split(".")[0],style:{width:"300px",display:"block"}}},click:function(e,o){if(o.Rename.val()&&o.Rename.val().trim()&&!o.Rename.val().match("\\.\\.")){"\\"!=s[0]&&"/"!=s[0]?s="\\"+s:"\\",$(a.children()[2]).text("Renaming..."),$.ajax({url:"/move",data:{userID:getCookie("UserID"),auth:l,path:s,newPath:s.replace(t,o.Rename.val()+"."+t.split(".")[1])},error:function(e){console.log(e),e.responseText&&sendAlert({text:e.responseText}),$.ajax({url:"/files",error:function(e){console.log(e)},dataType:"json",success:function(e){i(e)},type:"GET"})},dataType:"json",success:function(e){i(e)}})}}}),e.stopPropagation(),e.preventDefault()}),t.change&&t.change instanceof Function&&(I.addClass("hover2"),I.click(function(e){pathToFile=$(this).attr("filename"),"\\"!=pathToFile[0]&&"/"!=pathToFile[0]&&(pathToFile="\\"+pathToFile);var a=$(this).attr("filename").split("\\"),i=a[a.length-1].split("/")[a[a.length-1].split("/").length-1];t.change(e,$(this),game.user.token+"\\custom\\"+pathToFile,i)}));var D="",A=k.split("\\");for(var C in A)D+=A[C],C!=A.length-1&&(D+="/");var j=util.mediaType(D.toLowerCase()),S=$("<img>").appendTo(I);if(S.addClass("hover2"),S.attr("type",j),S.css("font-size",t.fontsize||"20px"),S.css("height",t.height||"25px"),S.css("width",t.width||"auto"),S.mousedown(function(e){e.stopPropagation()}),e.path?S.attr("srcFile","\\custom"+D):S.attr("srcFile","\\custom\\"+D),"img"==j)S.attr("src",S.attr("srcFile")),I.attr("src",S.attr("srcFile"));else if("audio"==j){var P=genIcon("volume-up");P.attr("src",S.attr("srcFile")),P.click(function(){_audioPreview&&_audioPreview.src==$(this).attr("src")?_audioPreview.paused?_audioPreview.play():_audioPreview.pause():(_audioPreview&&_audioPreview.pause(),_audioPreview=new Audio($(this).attr("src")),_audioPreview.volume=.2,_audioPreview.oncanplay=function(){_audioPreview.loadcheck||(_audioPreview.currentTime=Math.round((_audioPreview.duration||10)/2),_audioPreview.loadcheck=!0,_audioPreview.play())})}),S.replaceWith(P)}else"video"==j?S.replaceWith(genIcon("media")):"pdf"==j?S.replaceWith(genIcon("book")):S.replaceWith(genIcon("list-alt"));j&&t.filter&&(t.filter!=j.toLowerCase()||t.filter instanceof Object&&!util.contains(t.filter,j.toLowerCase()))?(I.removeClass("hover2"),I.addClass("subtitle"),I.css("background-color","rgb(235,235,228)"),S.css("height","15px")):assetTypes[j]&&(S.click(function(e){var a=$(this).attr("src");"\\"==a[0]&&(a=a.replace("\\","/")),assetTypes[S.attr("type")].preview(e,$(this),a),e.stopPropagation(),e.preventDefault()}),S.contextmenu(function(e){var a=$(this).attr("src");return"\\"==a[0]&&(a=a.replace("\\","/")),assetTypes[$(this).attr("type")].contextmenu(e,$(this),a),e.stopPropagation(),e.preventDefault(),!1})),I.append("<div class='flex'></div>");var h=genIcon("",_).appendTo(I);h.addClass("flexmiddle"),h.css("max-width","80%"),h.css("overflow","hidden"),_.length>30&&(h.addClass("subtitle"),h.attr("title",_)),I.append("<div class='flex'></div>");var y=genIcon("trash").appendTo(I);y.addClass("destroy"),y.attr("filename",k),y.click(function(e){var a=$(this).attr("filename");if(_deleting)sendAlert({text:"Deletion in progress"});else{"\\"!=a[0]&&"/"!=a[0]&&(a="\\"+a);var t=$(this).parent();ui_prompt({target:$(this),confirm:"Confirm Delete",click:function(e,s){_deleting=!0,t.remove(),sendAlert({text:"Deleting..."}),$.ajax({url:"/delete",data:{userID:getCookie("UserID"),auth:l,path:a},error:function(e){console.log(e),_deleting=!1,sendAlert({text:"Deletion Failed..."})},dataType:"json",success:function(e){_deleting=!1,i(e),sendAlert({text:"Deletion Successful"})}})}})}e.stopPropagation(),e.preventDefault()}),layout.fileControls||y.hide()}}return s}if(_localAuth=s,m.empty(),n(s).removeClass("outline").appendTo(m),p.empty(),s.size){p.append(sync.render("ui_progressBar")(e||{data:{}},a,{percentage:s.size,max:s.max,col:"rgb(@:int(200*@percentage),@:int(200-200*@percentage),0)"}).removeClass("fit-x").addClass("flex"));var r=$("<div class='alttext flexmiddle lrmargin' style='position : relative;'><div style='position : absolute; text-overflow: ellipsis; width : 50px;'>"+Math.round(s.size/s.max*100)+"%</div></div>").appendTo(p);r.css("transition","width 0.5s"),r.css("width","50px"),p.hover(function(){r.css("width","120px"),r.empty(),r.append("<div style='position : absolute; text-overflow: ellipsis; width : 120px;'>"+Math.round(s.size/1024/1024)+"mb / 100mb</div>"),r.text()},function(){r.css("width","50px"),r.empty(),r.append("<div style='position : absolute; text-overflow: ellipsis; width : 50px;'>"+Math.round(s.size/s.max*100)+"%</div>")})}}function s(){$.ajax({url:"/files",error:function(e){console.log(e)},dataType:"json",success:function(e){i(e)},type:"GET"
})}t=t||{width:a.attr("width"),height:a.attr("height"),fontsize:a.attr("fontsize")},game.locals.localFolders=game.locals.localFolders||sync.obj(),game.locals.localFolders.data=game.locals.localFolders.data||{};var o=game.locals.localFolders,n="http://127.0.0.1:30000",l="";game.user={token:""};var r=$("<div>");r.addClass("fit-xy flexcolumn"),layout.mobile||(r.on("dragover",function(e){if(e.preventDefault(),e.stopPropagation(),!$("#"+a.attr("id")+"-drag-overlay").length){var t=layout.overlay({target:r,id:a.attr("id")+"-drag-overlay",style:{"background-color":"rgba(0,0,0,0.5)","pointer-events":"none"}});t.addClass("flexcolumn flexmiddle alttext"),t.css("font-size","2em"),t.css("z-index",util.getMaxZ(".ui-popout")+1),t.append("<b>Drop to Upload</b>")}}),r.on("drop",function(e){e.preventDefault(),e.stopPropagation();var s=e.originalEvent.dataTransfer,o=s.files;if(o.length)for(var n=[],r={},d=0;d<o.length;d++)!function(e,a){var t=new FileReader;t.readAsDataURL(e),t.onload=function(e){r[a]=!0,n.push({name:o[a].name,blob:e.target.result.split(",")[1],path:"/"});for(var t=0;t<o.length;t++)if(!r[t])return!1;var s;u[0].files.length>1?sendAlert({text:"Uploading files...",duration:-1,id:"file-chunk"}):(s="file-"+a,sendAlert({text:"Uploading "+o[a].name+"...",duration:-1,id:"file-"+a})),$.ajax({type:"POST",url:"/upload",data:{upload:n,userID:getCookie("UserID"),auth:l},error:function(e){console.log(e),_deleting=!1,sendAlert({text:"Uploading Failed : "+e.responseText}),layout.coverlay($(".file-chunk"),1e3),layout.coverlay(s,1e3)},dataType:"json",success:function(e){_deleting=!1,i(e),sendAlert({text:"Upload Successful"}),layout.coverlay($(".file-chunk"),1e3),layout.coverlay(s,1e3)}})}}(o[d],d);else if(s.getData("Text")){var c=new Image;c.src=s.getData("Text"),c.onload=function(){if(t.change&&t.change instanceof Function){var a=c.src.split("\\"),i=a[a.length-1].split("/")[a[a.length-1].split("/").length-1];t.change(e,$(this),c.src,i)}}}layout.coverlay(a.attr("id")+"-drag-overlay")}),r.on("dragleave",function(e){e.preventDefault(),e.stopPropagation(),layout.coverlay(a.attr("id")+"-drag-overlay")}),r.mouseout(function(){layout.coverlay(a.attr("id")+"-drag-overlay")}));var d=$("<div>");d.addClass("flexrow flexbetween subtitle foreground outline fit-x");var c=$("<div>").appendTo(d);c.addClass("flexrow flexmiddle");var p=$("<div>").appendTo(d);p.addClass("flex flexrow flexmiddle lrmargin");var u=genInput({type:"file",parent:d}).addClass("white outline");u.css("opacity","0"),u.css("width","1px"),u.change(function(){if(u.attr("path")){var e=u.attr("path").split("\\"),a="";for(var t in e)a+=e[t],t<e.length-1&&(a+="/");for(var s=[],o={},t=0;t<u[0].files.length;t++)!function(e,t){var n=new FileReader;n.readAsDataURL(e),n.onload=function(e){o[t]=!0,s.push({name:u[0].files[t].name,blob:e.target.result.split(",")[1],path:a});for(var n=0;n<u[0].files.length;n++)if(!o[n])return!1;var r;u[0].files.length>1?sendAlert({text:"Uploading files...",duration:-1,id:"file-chunk"}):(r="file-"+t,sendAlert({text:"Uploading "+u[0].files[t].name+"...",duration:-1,id:"file-"+t})),$.ajax({type:"POST",url:"/upload",data:{upload:s,userID:getCookie("UserID"),auth:l},error:function(e){_deleting=!1,sendAlert({text:"Uploading Failed : "+e.responseText}),layout.coverlay($(".file-chunk"),1e3),layout.coverlay(r,1e3)},dataType:"json",success:function(e){_deleting=!1,i(e),sendAlert({text:"Upload Successful"}),layout.coverlay($(".file-chunk"),1e3),layout.coverlay(r,1e3)}}),u.removeAttr("path"),u.val("")}}(u[0].files[t],t)}});var g=$("<div>").appendTo(r);g.addClass("flex"),g.css("position","relative"),g.css("overflow-y","auto"),g.css("overflow-x","hidden"),g.css("cursor","pointer"),g.click(function(e){u.click(),e.stopPropagation(),e.preventDefault()});var m=$("<div>").appendTo(g);m.addClass("fit-x flexcolumn flexwrap"),m.css("position","absolute"),m.click(function(e){e.stopPropagation(),e.preventDefault()});var f=$("<div>").appendTo(m);f.addClass("fit-xy flexcolumn flexmiddle lpadding");var h=$("<text>").appendTo(f);h.addClass("flexmiddle flex middle"),h.css("font-size","2em"),h.css("-webkit-text-stroke-width","2px"),h.text("Establishing Connection...");var v=($("<div class='loader' style='height : 50px; width : 50px;'></div>").appendTo(f),genIcon("refresh","Refresh").appendTo(c));return v.addClass("alttext lrpadding"),v.css("color","white"),v.click(function(){sendAlert({text:"Refreshing"}),n=_localAuth,s()}),_localAuth?(m.addClass("foreground outline"),$.ajax({url:"/files?userID="+getCookie("UserID")+"&auth="+l,error:function(e){console.log(e)},dataType:"json",success:function(e){i(e)},type:"GET"}),i(_localAuth)):s(),d.appendTo(r),r}),sync.render("ui_gameCtrl",function(e,a,t){e||(e=game.config);var i=$("<div>");e&&e.data&&e.data;var s=$("<div>").appendTo(i);s.addClass("flexrow flexbetween");var o=$("<div>").appendTo(s);o.css("flex","1");var n=$("<div>").appendTo(o);n.addClass("flexcolumn"),genIcon("plus","Add Extension").click(function(){var t=sync.render("ui_filePicker")(e,a,{filter:"js",change:function(t,i,s){game.config.data.scripts=game.config.data.scripts||[],game.config.data.scripts.push(s),e.sync("updateConfig"),sync.updateApp(a,game.config),layout.coverlay("icons-picker")}});ui_popOut({target:$(this),prompt:!0,id:"icons-picker",align:"top",style:{width:assetTypes.filePicker.width,height:assetTypes.filePicker.height}},t).resizable()});for(var l in game.config.data.scripts){var r=$("<b class='subtitle'>"+game.config.data.scripts[l]+"</b>").appendTo(n),d=genIcon("remove").appendTo(r);d.addClass("destroy"),d.attr("index",l),d.click(function(){$(this).parent().remove(),game.config.data.scripts=game.config.data.scripts||[],game.config.data.scripts.splice($(this).attr("index"),1),e.sync("updateConfig")})}var c=$("<button>").appendTo(o);if(c.addClass("focus"),c.append("RESTORE ORIGNAL TEMPLATES"),c.click(function(){if(game.locals.gameList[game.templates.identifier])runCommand("updateTemplate",duplicate(game.locals.gameList[game.templates.identifier]));else{var e=$("<div>");e.addClass("flexcolumn fit-x");for(var a in game.locals.gameList){var t=$("<button>").appendTo(e);t.addClass("fit-x"),t.attr("index",a),t.text(sync.rawVal(game.locals.gameList[a].info.name)),t.click(function(){runCommand("updateTemplate",duplicate(game.locals.gameList[$(this).attr("index")])),layout.coverlay("restore")})}ui_popOut({target:$(this),id:"restore",style:{width:"400px",height:"400px"}},e)}}),!game.config.data.offline){var p=$("<button>");p.attr("title","Edit in Offline Mode"),p.append("Go Offline"),p.click(function(){setCookie("offlineGame"),runCommand("goOffline"),layout.coverlay("game-options-popout")})}return i});